<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pancakes' Replay Code Reader Thingy</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script>
        const re = /[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}/g
        const nintendoUrl = "https://s.nintendo.com/av5ja-lp1/znca/game/4834290508791808?p=%2Freplay%3Fcode%3D"

        function copy() {
            let textarea = document.getElementById("outputText");
            textarea.select();
            navigator.clipboard.writeText(textarea.value);

            let message = document.getElementById("message");
            if (message.textContent) {
                if (message.textContent.length > 15) {
                    message.textContent = message.textContent.concat("?")
                } else {
                    message.textContent = message.textContent.concat("!")
                }
            } else {
                message.textContent = "Copied"
            }
        }

        function update() {
            let inputText = document.getElementById("inputText");
            let inputString = inputText.value

            // Update the list of codes
            let matches = inputString.matchAll(re);
            let codes = document.getElementById("codes");
            codes.innerHTML = "";
            for (const match of matches) {
                let link = document.createElement("a")
                link.textContent = match[0];
                link.href = nintendoUrl.concat(match[0]);
                codes.appendChild(link)
            }
            if (codes.innerHTML == "") {
                codes.innerText = "No codes found";
            }

            // Update the output text
            matches = inputString.matchAll(re);
            let outputText = document.getElementById("outputText");
            outputText.value = "";
            var lastCode = 0;
            for (const match of matches) {
                let code = match[0];
                let prefix = inputString.slice(lastCode, match.index);
                let url = nintendoUrl.concat(code)
                outputText.value = outputText.value.concat(prefix, "[", code, "](", url, ")")
                lastCode = match.index + code.length;
            }
            // Add the last one
            outputText.value = outputText.value.concat(inputString.slice(lastCode));
        }
    </script>
</head>

<body>
    <div class="codeReader">
        <h1>Replay code reader thingy</h1>
        <div>
            <h2>Paste the text containing the replay codes</h2>
            <textarea id="inputText" name="inputText" rows="15" autofocus oninput="update()"></textarea>
        </div>
        <div class="replayCodes" id="codes">The codes be here</div>
        <div>
            <h2>Text with Discord-compatible links for the codes:</h2>
            <textarea id="outputText" name="outputText" rows="15" disabled></textarea>
        </div>
        <button onclick="copy()">Copy to clipboard</button>
        <span id="message"></span>
    </div>
</body>